## Описание
Учебная практика по SQL с применением Redash и PostgreSQL. Всё нижеописанное было проверено на ОС Windows 10.

В данном проекте имитируется работа с базой данных сервиса доставки.

Краткое описание таблиц:
- `users` - содержит записи о пользователях сервиса (id пользователя, дата рождения, пол)
- `user_actions` - содержит записи действиях пользователей (id пользователя, id заказа, действие, время)
- `couriers` - содержит записи о курьерах (id курьера, дата рождения, пол)
- `courier_actions` - содержит записи о действиях курьеров (id курьера, id заказа, действие, время)
- `products` - содержит записи о продуктах (id продукта, наименование, цена)
- `orders` - содержит записи о заказах (id заказа, время создания, перечисление id продуктов)

## Требования для локального запуска
- `Docker` и `docker compose` - для запуска контейнеров Redash и отдельной БД Postgres
- `Python` - для запуска скрипта импортирования данных в таблицы PostgreSQL

## Шаг 1 - запуск Redash и подготовка таблиц
1) Открыть в терминале (например, в терминале Windows PowerShell, Docker или VS Code) каталог `redash` и запустить команду: 
` docker-compose up -d ` (это запустит все необходимые контейнеры для работы Redash)
2) Открыть Redash в браузере по адресу: http://localhost:5000 (если появляется ошибка 500, скорее всего, БД для работы Redash ещё не создана, попробуйте зайти снова через пару минут)
3) Заполнить форму первичной настройки: имя администратора, почту, пароль, имя организации (можно вводить что угодно, т. к. это локальная версия для учебных целей)

![Инициализация Redash](./img/01_redash_initial.png)

4) Создать подключение для PostgreSQL (адрес хоста можно узнать командой в терминале ` docker network inspect bridge `, в строке "Gateway"; пароль такой же, как и User), если после сохранения по нажатию "Test Connection" получаем "Success", то всё хорошо

![Создание подключения PostgreSQL](./img/02_redash_postgres_conn.png)

5) Создать запрос (Query) и скопировать текст запроса из файла `create_tables.txt` в каталоге `tables`, затем выполнить запрос. Обновив список таблиц будет видно, что все таблицы добвалены в БД, но они пока что пустые

![Создание таблиц через запрос](./img/03_redash_create_tables_query.png)

## Шаг 2 - импорт данных из csv файлов в таблицы PostgreSQL
1) Открыть в терминале каталог `tables` со скриптом `import_data.py`, установить нужные зависимости командой: 
    ` pip install -r requirements.txt `

2) Запустить скрипт командой: 
    ` py import_data.py `

    
    ![Скрипт импорта](./img/04_python_import_data.png)

    **Важно!** Перед применением скрипта убедитесь, что таблицы пусты, иначе данные будут дописаны в конец уже существующих таблиц (то есть записи продублируются и придётся пересоздавать таблицы заново)

3) В Redash выполнить следующий запрос:
    ``` 
    ALTER TABLE orders 
    ALTER COLUMN product_ids
    TYPE INT[]
    USING string_to_array(substr(product_ids, 2, length(product_ids) - 2), ',')::int[]; 
    ```
    Это приведёт столбец `product_ids` в таблице `orders` от типа TEXT к правильному типу ARRAY

Готово. Можно приступать к работе с данными.